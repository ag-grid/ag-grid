import{ModuleNames as p}from"@ag-grid-community/core";import{EnterpriseCoreModule as R}from"@ag-grid-enterprise/core";import{AgProvidedColumnGroup as w,BeanStub as G,_includes as v,_last as M,_warnOnce as W,isProvidedColumnGroup as z}from"@ag-grid-community/core";var C=class extends G{constructor(){super(...arguments),this.beanName="toolPanelColDefService",this.isColGroupDef=e=>e&&typeof e.children<"u",this.getId=e=>this.isColGroupDef(e)?e.groupId:e.colId}wireBeans(e){this.columnModel=e.columnModel}createColumnTree(e){const t=[],i=(o,n)=>{if(this.isColGroupDef(o)){const r=o,a=typeof r.groupId<"u"?r.groupId:r.headerName,l=new w(r,a,!1,n),d=[];return r.children.forEach(h=>{const c=i(h,n+1);c&&d.push(c)}),l.setChildren(d),l}else{const r=o,a=r.colId?r.colId:r.field,l=this.columnModel.getColDefCol(a);return l||t.push(r),l}},s=[];return e.forEach(o=>{const n=i(o,0);n&&s.push(n)}),t.length>0&&W("unable to find grid columns for the supplied colDef(s):",t),s}syncLayoutWithGrid(e){const t=this.getLeafPathTrees(),i=this.mergeLeafPathTrees(t);e(i)}getLeafPathTrees(){const e=(s,o)=>{let n;if(z(s))if(s.isPadding())n=o;else{const a=Object.assign({},s.getColGroupDef());a.groupId=s.getGroupId(),a.children=[o],n=a}else{const a=Object.assign({},s.getColDef());a.colId=s.getColId(),n=a}const r=s.getOriginalParent();return r?e(r,n):n};return this.columnModel.getCols().filter(s=>{const o=s.getColDef();return s.isPrimary()&&!o.showRowGroup}).map(s=>e(s,s.getColDef()))}mergeLeafPathTrees(e){const t=(o,n)=>this.isColGroupDef(o)&&this.isColGroupDef(n)&&this.getId(o)===this.getId(n),i=(o,n)=>{if(!this.isColGroupDef(n))return o;const r=o,a=n;return a.children&&a.groupId&&this.addChildrenToGroup(r,a.groupId,a.children[0])||a.children.forEach(l=>i(r,l)),r},s=[];for(let o=1;o<=e.length;o++){const n=e[o-1],r=e[o];t(n,r)?e[o]=i(n,r):s.push(n)}return s}addChildrenToGroup(e,t,i){const s=(r,a)=>{const l=r.children.map(this.getId),d=v(l,this.getId(a)),h=M(r.children),c=h&&this.getId(h)!==this.getId(a);return d&&c};if(!this.isColGroupDef(e))return!0;const o=e,n=i;if(s(o,n))return o.children.push(n),!0;if(o.groupId===t){const r=o.children.map(this.getId);if(!v(r,this.getId(n)))return o.children.push(n),!0}return o.children.forEach(r=>this.addChildrenToGroup(r,t,i)),!1}};import{_unwrapUserComp as A}from"@ag-grid-community/core";function x(e){return e.sideBarService?.getSideBarComp().isDisplayed()??!1}function F(e,t){e.sideBarService?.getSideBarComp().setDisplayed(t)}function L(e,t){e.sideBarService?.getSideBarComp().setSideBarPosition(t)}function _(e,t){e.sideBarService?.getSideBarComp().openToolPanel(t,"api")}function K(e){e.sideBarService?.getSideBarComp().close("api")}function O(e){return e.sideBarService?.getSideBarComp().openedItem()??null}function k(e){e.sideBarService?.getSideBarComp().refresh()}function U(e){return e.sideBarService?.getSideBarComp().isToolPanelShowing()??!1}function N(e,t){const i=e.sideBarService?.getSideBarComp().getToolPanelInstance(t);return A(i)}function $(e){return e.sideBarService?.getSideBarComp().getDef()}import{BeanStub as V}from"@ag-grid-community/core";import{Component as j,KeyCode as u,ManagedFocusFeature as q,ModuleNames as S,ModuleRegistry as T,RefPlaceholder as Y,_addFocusableContainerListener as H,_removeFromParent as b,_setAriaControls as J,_warnOnce as f}from"@ag-grid-community/core";import{Component as Q,KeyCode as X,_clearElement as Z,_last as ee}from"@ag-grid-community/core";import{Component as te,RefPlaceholder as g,_createIconNoSpan as se,_setAriaExpanded as ie}from"@ag-grid-community/core";var oe=class extends te{constructor(e){super(),this.eToggleButton=g,this.eIconWrapper=g,this.eLabel=g,this.toolPanelDef=e}getToolPanelId(){return this.toolPanelDef.id}postConstruct(){const e=this.createTemplate();this.setTemplate(e,[]),this.setLabel(),this.setIcon(),this.addManagedElementListeners(this.eToggleButton,{click:this.onButtonPressed.bind(this)}),this.eToggleButton.setAttribute("id",`ag-${this.getCompId()}-button`)}createTemplate(){return`<div class="ag-side-button" role="presentation">
                <button type="button" data-ref="eToggleButton" tabindex="-1" role="tab" aria-expanded="false" class="ag-button ag-side-button-button">
                    <div data-ref="eIconWrapper" class="ag-side-button-icon-wrapper" aria-hidden="true"></div>
                    <span data-ref="eLabel" class="ag-side-button-label"></span>
                </button>
            </div>`}setLabel(){const e=this.localeService.getLocaleTextFunc(),t=this.toolPanelDef,i=e(t.labelKey,t.labelDefault);this.eLabel.innerText=i}setIcon(){this.eIconWrapper.insertAdjacentElement("afterbegin",se(this.toolPanelDef.iconKey,this.gos))}onButtonPressed(){this.dispatchLocalEvent({type:"toggleButtonClicked"})}setSelected(e){this.addOrRemoveCssClass("ag-selected",e),ie(this.eToggleButton,e)}getButtonElement(){return this.eToggleButton}},ne=class extends Q{constructor(){super('<div class="ag-side-buttons" role="tablist"></div>'),this.buttonComps=[]}wireBeans(e){this.focusService=e.focusService,this.visibleColsService=e.visibleColsService}postConstruct(){this.addManagedElementListeners(this.getFocusableElement(),{keydown:this.handleKeyDown.bind(this)})}handleKeyDown(e){if(e.key!==X.TAB||!e.shiftKey)return;const t=ee(this.visibleColsService.getAllCols());this.focusService.focusGridView(t,!0)&&e.preventDefault()}setActiveButton(e){this.buttonComps.forEach(t=>{t.setSelected(e===t.getToolPanelId())})}addButtonComp(e){const t=this.createBean(new oe(e));return this.buttonComps.push(t),this.appendChild(t),t.addEventListener("toggleButtonClicked",()=>{this.dispatchLocalEvent({type:"sideBarButtonClicked",toolPanelId:e.id})}),t}clearButtons(){this.buttonComps=this.destroyBeans(this.buttonComps),Z(this.getGui()),super.destroy()}destroy(){this.clearButtons(),super.destroy()}},re={selector:"AG-SIDE-BAR-BUTTONS",component:ne};import{_warnOnce as ae}from"@ag-grid-community/core";var y={id:"columns",labelDefault:"Columns",labelKey:"columns",iconKey:"columns",toolPanel:"agColumnsToolPanel"},I={id:"filters",labelDefault:"Filters",labelKey:"filters",iconKey:"filter",toolPanel:"agFiltersToolPanel"},m={columns:y,filters:I};function B(e){if(!e)return;if(e===!0)return{toolPanels:[y,I],defaultToolPanel:"columns"};if(typeof e=="string")return B([e]);if(Array.isArray(e)){const i=[];return e.forEach(s=>{const o=m[s];if(!o){D(s);return}i.push(o)}),i.length===0?void 0:{toolPanels:i,defaultToolPanel:i[0].id}}return{toolPanels:le(e.toolPanels),defaultToolPanel:e.defaultToolPanel,hiddenByDefault:e.hiddenByDefault,position:e.position}}function D(e){ae(`the key ${e} is not a valid key for specifying a tool panel, valid keys are: ${Object.keys(m).join(",")}`)}function le(e){const t=[];return e&&e.forEach(i=>{let s=null;if(typeof i=="string"){const o=m[i];if(!o){D(i);return}s=o}else s=i;t.push(s)}),t}import{Component as de,_warnOnce as he}from"@ag-grid-community/core";import{Component as ce}from"@ag-grid-community/core";var ue=class extends ce{constructor(){super('<div class="ag-tool-panel-horizontal-resize"></div>'),this.minWidth=100,this.maxWidth=null}wireBeans(e){this.horizontalResizeService=e.horizontalResizeService}setElementToResize(e){this.elementToResize=e}postConstruct(){const e=this.horizontalResizeService.addResizeBar({eResizeBar:this.getGui(),dragStartPixels:1,onResizeStart:this.onResizeStart.bind(this),onResizing:this.onResizing.bind(this),onResizeEnd:this.onResizeEnd.bind(this)});this.addDestroyFunc(e),this.setInverted(this.gos.get("enableRtl"))}dispatchResizeEvent(e,t,i){const s={type:"toolPanelSizeChanged",width:i,started:e,ended:t};this.eventService.dispatchEvent(s)}onResizeStart(){this.startingWidth=this.elementToResize.offsetWidth,this.dispatchResizeEvent(!0,!1,this.startingWidth)}onResizeEnd(e){return this.onResizing(e,!0)}onResizing(e,t=!1){const i=this.inverted?-1:1;let s=Math.max(this.minWidth,Math.floor(this.startingWidth-e*i));this.maxWidth!=null&&(s=Math.min(this.maxWidth,s)),this.elementToResize.style.width=`${s}px`,this.dispatchResizeEvent(!1,t,s)}setInverted(e){this.inverted=e}setMaxWidth(e){this.maxWidth=e}setMinWidth(e){e!=null?this.minWidth=e:this.minWidth=100}},pe=class extends de{wireBeans(e){this.userComponentFactory=e.userComponentFactory}constructor(){super('<div class="ag-tool-panel-wrapper" role="tabpanel"/>')}postConstruct(){const e=this.getGui(),t=this.resizeBar=this.createManagedBean(new ue);e.setAttribute("id",`ag-${this.getCompId()}`),t.setElementToResize(e),this.appendChild(t)}getToolPanelId(){return this.toolPanelId}setToolPanelDef(e,t){const{id:i,minWidth:s,maxWidth:o,width:n}=e;this.toolPanelId=i,this.width=n;const r=this.userComponentFactory.getToolPanelCompDetails(e,t),a=r.newAgStackInstance();if(this.params=r.params,a==null){he(`error processing tool panel component ${i}. You need to specify 'toolPanel'`);return}a.then(this.setToolPanelComponent.bind(this)),s!=null&&this.resizeBar.setMinWidth(s),o!=null&&this.resizeBar.setMaxWidth(o)}setToolPanelComponent(e){this.toolPanelCompInstance=e,this.appendChild(e.getGui()),this.addDestroyFunc(()=>{this.destroyBean(e)}),this.width&&(this.getGui().style.width=`${this.width}px`)}getToolPanelInstance(){return this.toolPanelCompInstance}setResizerSizerSide(e){const t=this.gos.get("enableRtl"),i=e==="left",s=t?i:!i;this.resizeBar.setInverted(s)}refresh(){this.toolPanelCompInstance?.refresh(this.params)}},fe=class extends j{constructor(){super(`<div class="ag-side-bar ag-unselectable">
            <ag-side-bar-buttons data-ref="sideBarButtons"></ag-side-bar-buttons>
        </div>`,[re]),this.sideBarButtons=Y,this.toolPanelWrappers=[]}wireBeans(e){this.focusService=e.focusService,this.filterManager=e.filterManager,this.sideBarService=e.sideBarService}postConstruct(){this.sideBarButtons.addEventListener("sideBarButtonClicked",this.onToolPanelButtonClicked.bind(this));const{sideBar:e}=this.gos.get("initialState")??{};this.setSideBarDef({sideBarDef:B(this.gos.get("sideBar")),sideBarState:e}),this.addManagedPropertyListener("sideBar",this.onSideBarUpdated.bind(this)),this.sideBarService.registerSideBarComp(this);const t=this.getFocusableElement();this.createManagedBean(new q(t,{onTabKeyDown:this.onTabKeyDown.bind(this),handleKeyDown:this.handleKeyDown.bind(this)})),H(this,t,this.focusService)}onTabKeyDown(e){if(e.defaultPrevented)return;const{focusService:t,sideBarButtons:i}=this,s=this.getGui(),o=i.getGui(),n=this.gos.getActiveDomElement(),r=s.querySelector(".ag-tool-panel-wrapper:not(.ag-hidden)"),a=e.target;if(!r)return;if(o.contains(n)){t.focusInto(r,e.shiftKey)&&e.preventDefault();return}if(!e.shiftKey)return;let l=null;r.contains(n)?l=this.focusService.findNextFocusableElement(r,void 0,!0):t.isTargetUnderManagedComponent(r,a)&&e.shiftKey&&(l=this.focusService.findFocusableElementBeforeTabGuard(r,a)),l||(l=o.querySelector(".ag-selected button")),l&&l!==e.target&&(e.preventDefault(),l.focus())}handleKeyDown(e){const t=this.gos.getActiveDomElement();if(!this.sideBarButtons.getGui().contains(t))return;const i=this.sideBarButtons.getGui(),s=Array.prototype.slice.call(i.querySelectorAll(".ag-side-button")),o=s.findIndex(a=>a.contains(t));let n=null;switch(e.key){case u.LEFT:case u.UP:n=Math.max(0,o-1);break;case u.RIGHT:case u.DOWN:n=Math.min(o+1,s.length-1);break}if(n===null)return;const r=s[n].querySelector("button");r&&(r.focus(),e.preventDefault())}onToolPanelButtonClicked(e){const t=e.toolPanelId;this.openedItem()===t?this.openToolPanel(void 0,"sideBarButtonClicked"):this.openToolPanel(t,"sideBarButtonClicked")}clearDownUi(){this.sideBarButtons.clearButtons(),this.destroyToolPanelWrappers()}setSideBarDef({sideBarDef:e,sideBarState:t,existingToolPanelWrappers:i}){if(this.setDisplayed(!1),this.sideBar=e,this.sideBar&&this.sideBar.toolPanels){const s=this.sideBar.toolPanels;if(this.createToolPanelsAndSideButtons(s,t,i),!this.toolPanelWrappers.length)return;const o=t?t.visible:!this.sideBar.hiddenByDefault;if(this.setDisplayed(o),this.setSideBarPosition(t?t.position:this.sideBar.position),o)if(t){const{openToolPanel:n}=t;n&&this.openToolPanel(n,"sideBarInitializing")}else this.openToolPanel(this.sideBar.defaultToolPanel,"sideBarInitializing")}}getDef(){return this.sideBar}setSideBarPosition(e){e||(e="right"),this.position=e;const t=e==="left",i=t?"right":"left";return this.addOrRemoveCssClass("ag-side-bar-left",t),this.addOrRemoveCssClass("ag-side-bar-right",!t),this.toolPanelWrappers.forEach(s=>{s.setResizerSizerSide(i)}),this.eventService.dispatchEvent({type:"sideBarUpdated"}),this}setDisplayed(e,t){super.setDisplayed(e,t),this.eventService.dispatchEvent({type:"sideBarUpdated"})}getState(){const e={};return this.toolPanelWrappers.forEach(t=>{e[t.getToolPanelId()]=t.getToolPanelInstance()?.getState?.()}),{visible:this.isDisplayed(),position:this.position,openToolPanel:this.openedItem(),toolPanels:e}}createToolPanelsAndSideButtons(e,t,i){for(const s of e)this.createToolPanelAndSideButton(s,t?.toolPanels?.[s.id],i?.[s.id])}validateDef(e){if(e.id==null)return f("please review all your toolPanel components, it seems like at least one of them doesn't have an id"),!1;if(e.toolPanel==="agColumnsToolPanel"&&!T.__assertRegistered(S.ColumnsToolPanelModule,"Column Tool Panel",this.gridId))return!1;if(e.toolPanel==="agFiltersToolPanel"){if(!T.__assertRegistered(S.FiltersToolPanelModule,"Filters Tool Panel",this.gridId))return!1;if(this.filterManager?.isAdvancedFilterEnabled())return f("Advanced Filter does not work with Filters Tool Panel. Filters Tool Panel has been disabled."),!1}return!0}createToolPanelAndSideButton(e,t,i){if(!this.validateDef(e))return;const s=this.sideBarButtons.addButtonComp(e);let o;i?o=i:(o=this.createBean(new pe),o.setToolPanelDef(e,{initialState:t,onStateUpdated:()=>this.eventService.dispatchEvent({type:"sideBarUpdated"})})),o.setDisplayed(!1);const n=o.getGui();this.appendChild(n),this.toolPanelWrappers.push(o),J(s.getButtonElement(),n)}refresh(){this.toolPanelWrappers.forEach(e=>e.refresh())}openToolPanel(e,t="api"){const i=this.openedItem();if(i===e)return;this.toolPanelWrappers.forEach(n=>{const r=e===n.getToolPanelId();n.setDisplayed(r)});const s=this.openedItem();i!==s&&(this.sideBarButtons.setActiveButton(e),this.raiseToolPanelVisibleEvent(e,i??void 0,t))}getToolPanelInstance(e){const t=this.toolPanelWrappers.filter(i=>i.getToolPanelId()===e)[0];if(!t){f(`unable to lookup Tool Panel as invalid key supplied: ${e}`);return}return t.getToolPanelInstance()}raiseToolPanelVisibleEvent(e,t,i){const s=!!e&&!!t;if(t){const o={type:"toolPanelVisibleChanged",source:i,key:t,visible:!1,switchingToolPanel:s};this.eventService.dispatchEvent(o)}if(e){const o={type:"toolPanelVisibleChanged",source:i,key:e,visible:!0,switchingToolPanel:s};this.eventService.dispatchEvent(o)}}close(e="api"){this.openToolPanel(void 0,e)}isToolPanelShowing(){return!!this.openedItem()}openedItem(){let e=null;return this.toolPanelWrappers.forEach(t=>{t.isDisplayed()&&(e=t.getToolPanelId())}),e}onSideBarUpdated(){const e=B(this.gos.get("sideBar")),t={};e&&this.sideBar&&e.toolPanels?.forEach(i=>{const{id:s}=i;if(!s)return;const o=this.sideBar.toolPanels?.find(l=>l.id===s);if(!o||i.toolPanel!==o.toolPanel)return;const n=this.toolPanelWrappers.find(l=>l.getToolPanelId()===s);if(!n)return;const r=this.gos.addGridCommonParams({...i.toolPanelParams??{},onStateUpdated:()=>this.eventService.dispatchEvent({type:"sideBarUpdated"})});n.getToolPanelInstance()?.refresh(r)===!0&&(this.toolPanelWrappers=this.toolPanelWrappers.filter(l=>l!==n),b(n.getGui()),t[s]=n)}),this.clearDownUi(),this.setSideBarDef({sideBarDef:e,existingToolPanelWrappers:t})}destroyToolPanelWrappers(){this.toolPanelWrappers.forEach(e=>{b(e.getGui()),this.destroyBean(e)}),this.toolPanelWrappers.length=0}destroy(){this.destroyToolPanelWrappers(),super.destroy()}},ge={selector:"AG-SIDE-BAR",component:fe},me=class extends V{constructor(){super(...arguments),this.beanName="sideBarService"}registerSideBarComp(e){this.sideBarComp=e}getSideBarComp(){return this.sideBarComp}getSideBarSelector(){return ge}},P="32.0.2",E={version:P,moduleName:`${p.SideBarModule}-core`,beans:[C,me],dependantModules:[R]},Be={version:P,moduleName:`${p.SideBarModule}-api`,apiFunctions:{isSideBarVisible:x,setSideBarVisible:F,setSideBarPosition:L,openToolPanel:_,closeToolPanel:K,getOpenedToolPanel:O,refreshToolPanel:k,isToolPanelShowing:U,getToolPanelInstance:N,getSideBar:$},dependantModules:[E]},Pe={version:P,moduleName:p.SideBarModule,dependantModules:[E,Be]};export{Pe as SideBarModule,C as ToolPanelColDefService};
